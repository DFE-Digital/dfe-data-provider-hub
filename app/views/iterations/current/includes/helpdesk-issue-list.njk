{% from "button/macro.njk" import govukButton %}
{% macro helpdeskIssueList(params) %}
<div class="govuk-grid-row">

    <div class="govuk-grid-column-full">

        <table id="issueTable" class="govuk-table govuk-table--top-align issue-table hide-caption">
            
            <caption class="govuk-table__caption">Issues</caption>
            
            
            <thead class="govuk-table__head">
                <tr class="govuk-table__row">
                    
                    <th class="govuk-table__header" scope="col">
                        Issue
                    </th>

                    <th class="govuk-table__header" scope="col">
                        Type
                    </th>

                    <th class="govuk-table__header" scope="col">
                        Acceptable explanation guide
                    </th>

                    <th class="govuk-table__header wider-cell" scope="col">
                        Explanation
                    </th>
                    
                    <th class="govuk-table__header numeric" scope="col">
                    </th>
                
                </tr>
            </thead>
            
            <tbody class="govuk-table__body">

                {% for issue in params.issues | sort(false, true, 'category') %}

                    <tr class="govuk-table__row">
                        <th class="govuk-table__header issue-description" scope="row" data-sort-value="{{ issue.number }}">
                            <h3 class="govuk-heading-m govuk-!-margin-bottom-1 issueData" data-modal-id="modal-title">
                                {{ issue.number }}
                                {% if issue.pupils | length > 0 %}
                                    <span class="no-wrap type-tag count  govuk-!-margin-left-2">
                                        {% if issue.pupils | length != 1 %}
                                            {{ issue.pupils | length }} pupils
                                            {% set consolidatedQuery = true %}
                                        {% else %}
                                            1 pupil
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </h3>
                            <p class="issueData" data-modal-id="modal-description">
                                {{ issue.description | addFullStop }}
                            </p>
                            <div class="issueData" data-modal-id="selected-issue" style="display: none;">{{ issue.id }}</div>
                        </th>

                        <td class="govuk-table__cell">
                            <span class="no-wrap type-tag {{ issue.category }} govuk-!-margin-right-8 issueCategory">
                                {{ issue.category | sentenceCase }}
                            </span>
                        </td>

                        <td class="govuk-table__cell">
                            {{ issue.guide | orElse('<b>Errors are not acceptable in most cases.</b><br>Please seek the advice of DDU if in doubt.') | safe }}
                        </td>

                        <td class="govuk-table__cell wider-cell">
                            {% if issue.notes | length == 0 %}
                                âˆ’
                            {% else %}
                                {% for note in issue.notes | sort(true, true, 'date') %}
                                    <div class="note {{ note.type }}">
                                        <span class="title">{{ 'Approved by ' if note.type == 'approval' }}{{ 'Rejected by ' if note.type == 'reply' }}{{ 'Explanation added by ' if note.type == 'school' }} {{ note.author }}<br>{{ note.date | formatDate }}</span>
                                        {{ note.text }}
                                    </div>
                                {% endfor -%}
                            {% endif %}
                        </td>

                        <td class="govuk-table__cell govuk-table__cell--numeric">
                            <div class="action-buttons">
                                {% if issue.pupils == null or issue.pupils | length == 0 %}
                                    <form action="/issue/accept" method="post">
                                        <input type="hidden" name="selected-issue" value="{{ issue.id }}">
                                        <input type="hidden" name="success-page" value="#root#/helpdesk/school/issues">
                                        {{ govukButton({
                                            html: 'Accept'
                                        }) }}
                                    </form>
                                   <form action="/issue/reject" method="post">
                                        <input type="hidden" name="selected-issue" value="{{ issue.id }}">
                                        <input type="hidden" name="success-page" value="#root#/helpdesk/school/issues">
                                        {{ govukButton({
                                            html: 'Reject',
                                            classes: 'govuk-button--warning'
                                        }) }}
                                    </form>
                                {% else %}
                                    <button type="button" class="govuk-button app-button-blue open-modal">
                                        View {{ 'pupil' if issue.pupils | length == 1 else issue.pupils | length | countLabel('pupil', 'pupils') }}
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>

                {% endfor %}
                
            </tbody>
        </table>

    </div>

</div>
{% endmacro %}